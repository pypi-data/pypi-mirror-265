image: python:latest

stages:
  - Packages
  - Build & Publish

install-framework:
  stage: Packages
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install twine
    - pip install .

publish-testpypi:
  stage: Build & Publish
  script: 
    - pip install build twine
    - python -m build
    - python -m twine upload --repository testpypi --username $TEST_PYPI_USERNAME --password $TEST_PYPI_PASSWORD dist/*
  except:
    - /^v\d+\.\d+\.\d+$/

publish:
  stage: Build & Publish
  script: 
    - pip install build twine
    - python -m build
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
    - python -m twine upload --repository pypi --username "${PYPI_USERNAME}" --password "${PYPI_PASSWORD}" --verbose dist/*
  only:
    - /^v\d+\.\d+\.\d+$/  # This will match tags with the format vX.Y.Z
    
