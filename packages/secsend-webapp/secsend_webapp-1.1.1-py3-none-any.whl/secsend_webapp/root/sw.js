(()=>{"use strict";var e={247:(e,t,n)=>{n.r(t),n.d(t,{decode:()=>o,encode:()=>a});for(var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="undefined"==typeof Uint8Array?[]:new Uint8Array(256),r=0;r<s.length;r++)i[s.charCodeAt(r)]=r;var a=function(e){var t,n=new Uint8Array(e),i=n.length,r="";for(t=0;t<i;t+=3)r+=s[n[t]>>2],r+=s[(3&n[t])<<4|n[t+1]>>4],r+=s[(15&n[t+1])<<2|n[t+2]>>6],r+=s[63&n[t+2]];return i%3==2?r=r.substring(0,r.length-1)+"=":i%3==1&&(r=r.substring(0,r.length-2)+"=="),r},o=function(e){var t,n,s,r,a,o=.75*e.length,c=e.length,u=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var l=new ArrayBuffer(o),h=new Uint8Array(l);for(t=0;t<c;t+=4)n=i[e.charCodeAt(t)],s=i[e.charCodeAt(t+1)],r=i[e.charCodeAt(t+2)],a=i[e.charCodeAt(t+3)],h[u++]=n<<2|s>>4,h[u++]=(15&s)<<4|r>>2,h[u++]=(3&r)<<6|63&a;return l}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=n(247);function t(e,t,n){const s=(new TextEncoder).encode(n),i=new Uint8Array([...s,...new Uint8Array(t)]);return e.subtle.digest("SHA-256",i)}var s;!function(e){e[e.File_=0]="File_",e[e.Root=1]="Root"}(s||(s={}));class i extends Error{constructor(e){super("invalid ID '"+e+"'")}}class r{id;constructor(e){this.id=e}static fromStr(t,n){const r=new Uint8Array((c=(c=t).replace(/-/g,"+").replace(/_/g,"/"),c+=Array(2-c.length%3).join("="),e.decode(c)));var c;const u=r[0],l=r.slice(1);if(null!==n&&n!==u)throw new i(t);switch(u){case s.Root:return new o(l.buffer);case s.File_:return new a(l.buffer);default:throw new i(t)}}str(){return t=new Uint8Array([this.kind(),...new Uint8Array(this.id)]),e.encode(t).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_");var t}}class a extends r{kind(){return s.File_}}class o extends r{kind(){return s.Root}async fileID(e){const n=await t(e,this.id,"secsend_fiid");return new a(n.slice(0,10))}}class c{iv;key;fileKey;metadataKey;crypto;static KEY_LEN=16;static TAG_LEN=16;static IV_LEN=12;static PROTO_NAME="aes-gcm";protoName(){return c.PROTO_NAME}constructor(e,t,n,s,i){this.iv=t,this.key=n,this.fileKey=s,this.metadataKey=i,this.crypto=e}static async import(e,n,s){const i=t=>e.subtle.importKey("raw",t,"AES-GCM",!1,["encrypt","decrypt"]),r=function(e,n){return t(e,n,"secsend_file")}(e,s).then(i),a=function(e,n){return t(e,n,"secsend_meta")}(e,s).then(i);return new c(e,n,s,await r,await a)}static async generate(e){const t=new Uint8Array(12),n=new Uint8Array(16),s=e.getRandomValues(t),i=e.getRandomValues(n);return await s,await i,c.import(e,t.buffer,n.buffer)}static outChunkSize(e){return e+c.TAG_LEN}static encryptedSize(e,t){let n=Math.floor(e/t)*(t+c.TAG_LEN);const s=e%t;return s>0&&(n+=s+c.TAG_LEN),n}static decryptedSize(e,t){const n=this.outChunkSize(t);let s=Math.floor(e/n)*t;const i=e%n;return i>0&&(s+=i-c.TAG_LEN),s}fragment(){return this.key}async encrypt(e,t){const n=this.algoChunk(t);return this.crypto.subtle.encrypt(n,this.fileKey,e)}async decrypt(e,t){const n=this.algoChunk(t);return this.crypto.subtle.decrypt(n,this.fileKey,e)}async encrSignMetadata(e,t){const n=this.algoChunk(e);return this.crypto.subtle.encrypt(n,this.metadataKey,t)}async decrVerifyMetadata(e,t){const n=this.algoChunk(e);return this.crypto.subtle.decrypt(n,this.metadataKey,t)}algoChunk(e){return{name:"AES-GCM",iv:this.chunkIV(e),tagLength:8*c.TAG_LEN}}chunkIV(e){const t=this.iv.slice(0),n=new DataView(t);let s=n.getBigUint64(0,!0);return s+=BigInt(e),n.setBigUint64(0,s,!0),t}}const u=new Map([[c.PROTO_NAME,c]]);function l(e,n,s){return t(e,new Uint8Array([...new Uint8Array(s),...new Uint8Array(n)]),"secsend_sign")}const h=n(247);class d extends Error{}class p extends d{constructor(e){super("unsupported algorithm '"+e+"'")}}class f extends d{constructor(e){super("unsupported version '"+e+"'")}}class y{version;name;mimeType;iv;chunkSize;algo;complete;keySign;timeoutSec;constructor(e,t,n,s,i,r,a,o,c){this.version=e,this.name=t,this.mimeType=n,this.iv=s,this.chunkSize=i,this.algo=r,this.complete=a,this.keySign=o,this.timeoutSec=c}jsonable(){return{version:this.version,name:h.encode(this.name),mime_type:h.encode(this.mimeType),iv:h.encode(this.iv),chunk_size:h.encode(this.chunkSize),algo:this.algo,complete:this.complete,key_sign:h.encode(this.keySign),timeout_s:this.timeoutSec}}static fromJsonable(e){if(!u.has(e.algo))throw new p(e.algo);if(1!==e.version)throw new f(e.version);const t=h.decode(e.iv),n=h.decode(e.key_sign),s=h.decode(e.name),i=h.decode(e.mime_type),r=h.decode(e.chunk_size);return new y(e.version,s,i,t,r,e.algo,e.complete,n,e.timeout_s)}}class m{version;name;mimeType;iv;chunkSize;algo;complete;keySign;timeoutSec;constructor(e,t,n,s,i,r,a,o,c){this.version=e,this.name=t,this.mimeType=n,this.iv=s,this.chunkSize=i,this.algo=r,this.complete=a,this.keySign=o,this.timeoutSec=c}static async create(e,t,n,s){const i=await l(n.crypto,await n.fragment(),n.iv);return new m(1,e,t,n.iv,1048576,n.protoName(),!0,i,s)}static async fromFile(e,t,n){let s=e.type;return""===s&&(s="application/octet-stream"),m.create(e.name,s,t,n)}}class g extends Error{}class w extends Error{res;err;constructor(e,t){super(t.message),this.res=e,this.err=t}static async check(e){if(!e.ok)throw new w(e,await e.json())}}const S=n(247);class k{id;key;fileURL;fileURLPromise;constructor(e,t,n){this.id=e,this.key=t,e instanceof a?(this.fileURL=this,this.fileURLPromise=null):(this.fileURL=null,this.fileURLPromise=e.fileID(n).then((e=>{this.fileURL=new k(e,t,n)})))}static keyFromTxt(e){const t=function(e){return[...e].reduce(((e,t)=>36n*e+BigInt(parseInt(t,36))),0n)}(e),n=new ArrayBuffer(16),s=new DataView(n);return s.setBigUint64(0,BigInt.asUintN(64,t),!0),s.setBigUint64(8,BigInt.asUintN(64,t>>64n),!0),n}static keyToTxt(e){const t=new DataView(e);return(t.getBigUint64(0,!0)|t.getBigUint64(8,!0)<<64n).toString(36)}jsonable(){return{id:this.id.str(),key:S.encode(this.key)}}static fromJsonable(e,t){return new k(r.fromStr(e.id,null),S.decode(e.key),t)}}class v{chunkSize;partialChunk;offset;constructor(e){this.chunkSize=e,this.partialChunk=new Uint8Array(e),this.offset=0}transform(e,t){let n=0;if(this.offset>0){const s=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(new Uint8Array(e.slice(0,s)),this.offset),this.offset+=s,n+=s,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;n<e.byteLength;){const s=e.byteLength-n;if(s>=this.chunkSize){const s=e.slice(n,n+this.chunkSize);n+=this.chunkSize,this.send(new Uint8Array(s),t)}else{const t=e.slice(n,n+s);n+=t.byteLength,this.partialChunk.set(new Uint8Array(t)),this.offset=t.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}send(e,t){t.enqueue(e),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}}class b{cipherFunc;chunkIdx;constructor(e,t){this.chunkIdx=t,this.cipherFunc=e}start(){}flush(){}async transform(e,t){try{const n=await this.cipherFunc(e,this.chunkIdx);t.enqueue(new Uint8Array(n))}catch(e){t.error(e)}this.chunkIdx+=1}}class T{firstSkip;lastSize;prevChunk;constructor(e,t){this.firstSkip=e,this.lastSize=t,this.prevChunk=null}transform(e,t){null!==this.prevChunk?(t.enqueue(this.prevChunk),this.prevChunk=e):this.prevChunk=e.slice(this.firstSkip)}flush(e){if(null===this.prevChunk)return;let t;t=null!==this.lastSize?this.prevChunk.slice(0,this.lastSize):this.prevChunk,e.enqueue(t)}}function C(e,t,n=null){try{return e.pipeThrough(new TransformStream(t))}catch(s){const i=e.getReader();return new ReadableStream({start(e){if(t.start)return t.start(e)},async pull(e){let n=!1;const s={enqueue(t){n=!0,e.enqueue(t)}};for(;!n;){const n=await i.read();if(n.done)return t.flush&&await t.flush(e),e.close();await t.transform(n.value,s)}},cancel(t){e.cancel(t),null!==n&&n(t)}})}}class L{inStreamSeekBytes;outStreamBeginSkip;inChunkBegin;inStreamLength;outStreamLastSize;outStreamBegin;outStreamLength;constructor(e,t,n,s,i,r,a){this.inStreamSeekBytes=t,this.inChunkBegin=e,this.inStreamLength=s,this.outStreamBeginSkip=n,this.outStreamLastSize=i,this.outStreamBegin=r,this.outStreamLength=a}inStreamRangeEnd(){return null===this.inStreamLength?null:this.inStreamLength+this.inStreamSeekBytes-1}static compute(e,t,n,s){let i=0,r=0,a=0;if(null!==n){const s=Math.floor(n/t);i=s*e,r=n%t,a=s}let o=null,c=null;return null!==s&&(o=Math.ceil(s/t)*e,c=s%t),new L(a,i,r,o,c,n,s)}outTruncator(){return new T(this.outStreamBeginSkip,this.outStreamLastSize)}}const A=new class{base;constructor(e){this.base=e.replace(/[/ ]+$/g,"")}async metadata(e){const t=await fetch(this.url("metadata/"+e.str()),{method:"GET"});await w.check(t);const n=await t.json();return{metadata:y.fromJsonable(n.metadata),size:n.size}}async config(){const e=await fetch(this.url("config"),{method:"GET"});return await w.check(e),await e.json()}async upload_new(e){const t=await fetch(this.url("upload/new"),{method:"POST",body:JSON.stringify(e.jsonable())});return await w.check(t),o.fromStr((await t.json()).root_id,s.Root)}async upload_push_blob(e,t,n,s){return new Promise(((i,r)=>{const a=new XMLHttpRequest;let o=null,c=null;a.upload.onprogress=e=>{clearTimeout(o),o=setTimeout((()=>{c=new w(null,{message:"request timeout",status:400,description:"request timeout"}),a.abort()}),2e3),n(e.loaded)},a.onabort=()=>{clearTimeout(o),r(c)},a.onerror=()=>{clearTimeout(o),r(new w(null,{message:"request error",status:400,description:"request error"}))},a.onload=()=>{clearTimeout(o),200!==a.status&&r(new w(null,a.response)),i()},a.open("POST",this.url("upload/push/"+e.str()),!0),a.setRequestHeader("Content-Type","application/octet-stream"),a.send(t),s.addOnCancel((()=>{clearTimeout(o),c=new g,a.abort()}))}))}async upload_finish(e){const t=await fetch(this.url("upload/finish/"+e.str()),{method:"POST"});await w.check(t)}async delete(e){const t=await fetch(this.url("delete/"+e.str()),{method:"POST"});await w.check(t)}url(e){return this.base+"/v1/"+e}}("/");self.addEventListener("fetch",(async e=>{e.request.url.includes("/v1/download/")&&e.respondWith(async function(){const t=e.request.url,{url:n,preview:s}=function(e,t){const n=new URL(e),s=n.hash.substr(1),i=n.pathname.substr("/v1/download/".length),a=r.fromStr(i,null),o="1"===n.searchParams.get("v");return{url:new k(a,k.keyFromTxt(s),t),preview:o}}(t,self.crypto);await n.fileURLPromise;const{key:i,id:a}=n.fileURL,o=new URL(t);o.pathname="/v1/download/"+a.str();const u=await A.metadata(a).catch((e=>e));if(u instanceof w)return new Response("Error: "+u.message,{status:u.err.status,statusText:u.err.description});const{metadata:h,size:d}=u;if(!1===h.complete)return new Response("Error: file is still being uploaded",{status:400,statusText:"Invalid request"});if(h.algo!==c.PROTO_NAME)return new Response("Error: unsupported encryption algorithm",{status:400,statusText:"Invalid request"});if(!1===await async function(e,t,n,s){return function(e,t){const n=new DataView(e),s=new DataView(t);if(n.byteLength!==s.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n.getUint8(e)!==s.getUint8(e))return!1;return!0}(await l(e,n,s),t)}(self.crypto,h.keySign,i,h.iv))return new Response("Invalid password",{status:403,statusText:"Forbidden access"});const p=await c.import(self.crypto,h.iv,i),f=await async function(e,t){const n=async(e,n)=>(n=await t.decrVerifyMetadata(e,n),(new TextDecoder).decode(n));return new m(e.version,await n(0,e.name),await n(1,e.mimeType),e.iv,await(async(e,n)=>(n=await t.decrVerifyMetadata(2,n),new DataView(n).getUint32(0,!0)))(0,e.chunkSize),e.algo,e.complete,e.keySign,e.timeoutSec)}(h,p),y=c.decryptedSize(d,f.chunkSize),g=c.outChunkSize(f.chunkSize),S=e.request.headers.get("Range"),T=function(e,t,n,s){if(null===e)return null;const i=e.match(/bytes=([0-9]+)-([0-9]+)?/),r=i[1]||null,a=i[2]||null;if(null===r&&null===a)return null;const o=parseInt(r,10);if(0===o&&null===a)return null;let c;return c=null!==a?parseInt(a,10)-o-1:s-o,L.compute(n,t,o,c)}(S,f.chunkSize,g,y),U=new Request(o.toString(),{headers:e.request.headers}),R={};let _=0;if(null!==T){_=T.inChunkBegin;let e="bytes="+T.inStreamSeekBytes+"-";const t=T.inStreamRangeEnd();null!==t&&(e+=t),R.Range=e}const z=await fetch(U.url,{headers:R}),x=await z.body,E=new b((B=p,(e,t)=>B.decrypt(e,t)),_);var B;let q=C(x,new v(g));q=C(q,E),T&&(q=C(q,T.outTruncator()));const I=new Headers(await z.headers);I.delete("Content-Range"),I.delete("Content-Length"),I.delete("Content-Disposition"),I.delete("Content-Type");let P=s?"inline":"attachment";P+="; filename="+f.name,I.append("Content-Disposition",P);let M=f.mimeType;if("text/html"===M&&(M="text/plain"),I.append("Content-Type",M),null===S)I.append("Content-Length",y.toString());else{let e,t;if(null===T)e="bytes 0-"+(y-1)+"/"+y,t=y,I.append("Accept-Ranges","bytes");else{const n=T.outStreamLength+T.outStreamBegin-1;e="bytes "+T.outStreamBegin+"-"+n+"/"+y,t=T.outStreamLength}I.append("Content-Range",e),I.append("Content-Length",t.toString())}return I.delete("Content-Security-Policy"),I.append("Content-Security-Policy","script-src 'none'"),new Response(q,{status:z.status,statusText:z.statusText,headers:I})}())}))})()})();