//- Gertrude --- GTD done right
//- Copyright Â© 2023 Tanguy Le Carrour <tanguy@bioneland.org>
//-
//- This program is free software: you can redistribute it and/or modify
//- it under the terms of the GNU Affero General Public License as
//- published by the Free Software Foundation, either version 3 of the
//- License, or (at your option) any later version.
//-
//- This program is distributed in the hope that it will be useful,
//- but WITHOUT ANY WARRANTY; without even the implied warranty of
//- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//- GNU Affero General Public License for more details.
//-
//- You should have received a copy of the GNU Affero General Public License
//- along with this program. If not, see <http://www.gnu.org/licenses/>.

extends layout

block title
  title= _("pages-tasks-display-title")

block modal
  include mixins/actions

  .modal.is-active(_="on closeModal remove me")
    .modal-background(_="on click trigger closeModal then halt default")
    .modal-card
      header.modal-card-head
        p.modal-card-title= _("pages-tasks-display-title")
        a.delete(
          href=url_for("tasks.inbox")
          _="on click trigger closeModal then halt default"
          aria-label= _("pages-modal-close")
        )

      section.modal-card-body(
        hx-boost="true"
        hx-target="#modal"
      )
        .buttons.is-pulled-right
          a.button.is-link(
            href=url_for("tasks.update_form", id=task.id)
            title=_("pages-mixins-list-of-tasks-update-title")
          )
            span.icon.is-small: i.fas.fa-pen(aria-hidden="true")
            span= _("pages-mixins-list-of-tasks-update-label")

        strong= task.title

        if task.description
          div.mt-2!= task.description

        if task.assigned_to or task.delegated_to
          hr

          dl
            if task.assigned_to
              - var project = projects_by_id[task.assigned_to]
              dt= _("pages-tasks-display-assigned-to")
              dd
                a(href=url_for("projects.display", id=project.id))= project.name
            if task.delegated_to
              dt= _("pages-tasks-display-delegated-to")
              dd= task.delegated_to

        hr

        h2.title.is-5.mt-5= _("pages-tasks-display-what-next")

        if errors.other:
          article.message.is-danger: .message-body: p= errors.other

        - var csrf_token = generate_csrf_token()

        if task.state == "captured"
          h3.title.is-6.has-text-centered= _("pages-tasks-display-is-actionable")
          .columns
            .column
              .message.is-success.has-text-centered: .message-body: p: strong= _("pages-tasks-display-yes")
              p.mt-3= _("pages-tasks-display-conditions-do")
              +do(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-delegate")
              +delegate(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-projectify")
              +projectify(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-postpone")
              +postpone(task, csrf_token)
            .column
              .message.is-danger.has-text-centered: .message-body: p: strong= _("pages-tasks-display-no")
              p.mt-3= _("pages-tasks-display-conditions-assign")
              +assign(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-schedule")
              +schedule(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-incubate")
              +incubate(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-file")
              +file(task, csrf_token)
              p.mt-3= _("pages-tasks-display-conditions-eliminate")
              +eliminate(task, csrf_token)

        elif possible_next_states
          .columns
            if "DONE" in possible_next_states
              .column: +do(task, csrf_token)
            if "DELEGATED" in possible_next_states
              .column: +delegate(task, csrf_token)
            if "ACTIONABLE" in possible_next_states
              .column: +postpone(task, csrf_token)
          .columns
            if "SCHEDULED" in possible_next_states
              .column: +schedule(task, csrf_token)
            if "FILED" in possible_next_states
              .column: +file(task, csrf_token)
            if "INCUBATED" in possible_next_states
              .column: +incubate(task, csrf_token)
            if "ELIMINATED" in possible_next_states
              .column: +eliminate(task, csrf_token)

        else
          article.message.is-info
            p.message-body= _("pages-tasks-display-no-action")
